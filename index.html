<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parfumelite Analytics</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/vn.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            500: '#14b8a6', // Teal main
                            600: '#0d9488',
                            900: '#134e4a',
                        },
                        accent: {
                            purple: '#8b5cf6',
                            rose: '#f43f5e',
                            amber: '#f59e0b',
                            blue: '#3b82f6'
                        }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
                    },
                    backdropBlur: {
                        'xs': '2px',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
            background-image:
                radial-gradient(at 0% 0%, rgba(20, 184, 166, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.1) 0px, transparent 50%);
        }

        /* Glassmorphism Card Utils */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
        }

        /* Animations */
        .fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .delay-100 {
            animation-delay: 100ms;
        }

        .delay-200 {
            animation-delay: 200ms;
        }

        .delay-300 {
            animation-delay: 300ms;
        }

        .delay-400 {
            animation-delay: 400ms;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body class="text-slate-800 antialiased min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass-header">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-gradient-to-tr from-brand-500 to-accent-purple flex items-center justify-center text-white shadow-lg shadow-brand-500/20">
                        <i class="ph ph-chart-polar text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-xl tracking-tight text-slate-900 leading-tight">Parfumelite</h1>
                        <p class="text-xs text-slate-500 font-medium">Analytics Dashboard</p>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-4">
                    <!-- Comparison Switch -->
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="compareToggle" class="sr-only peer">
                        <div
                            class="relative w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-brand-500">
                        </div>
                        <span class="ms-2 text-sm font-medium text-slate-600">So sánh</span>
                    </label>

                    <!-- Date Picker Button -->
                    <button id="datePickerBtn"
                        class="flex items-center gap-2 bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-xl text-sm font-medium hover:bg-slate-50 transition-all shadow-sm">
                        <i class="ph ph-calendar-blank text-lg"></i>
                        <span id="dateText">30 ngày qua</span>
                        <i class="ph ph-caret-down text-slate-400"></i>
                    </button>

                    <button onclick="refreshData()"
                        class="flex items-center gap-2 bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-xl text-sm font-medium transition-all shadow-lg shadow-slate-900/10 active:scale-95">
                        <i class="ph ph-arrows-clockwise"></i>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full space-y-8">

        <!-- ========== SECTION 1: CHANNEL (FB vs IG) ========== -->
        <div class="fade-in-up">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-1 h-8 bg-gradient-to-b from-blue-500 to-pink-500 rounded-full"></div>
                <div>
                    <h2 class="text-xl font-bold text-slate-900">Theo Kênh (Channel)</h2>
                    <p class="text-slate-500 text-sm">Facebook vs Instagram</p>
                </div>
            </div>
        </div>

        <!-- Channel KPI Cards -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in-up delay-100">
            <!-- Facebook Card -->
            <div class="glass-card rounded-2xl p-6 border-l-4 border-blue-500">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 rounded-xl bg-blue-500 flex items-center justify-center">
                        <i class="ph-fill ph-facebook-logo text-2xl text-white"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-slate-900">Facebook</h3>
                        <p class="text-xs text-slate-500">Hiệu suất quảng cáo FB</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="fb-kpis">
                    <div class="text-center p-3 bg-slate-50 rounded-xl">
                        <p class="text-xs text-slate-500 mb-1">Chi tiêu</p>
                        <p class="text-lg font-bold text-slate-900" id="fb-spend">--</p>
                        <p class="text-xs mt-1 hidden" id="fb-spend-change"></p>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-xl">
                        <p class="text-xs text-slate-500 mb-1">Impressions</p>
                        <p class="text-lg font-bold text-slate-900" id="fb-impressions">--</p>
                        <p class="text-xs mt-1 hidden" id="fb-impressions-change"></p>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-xl">
                        <p class="text-xs text-slate-500 mb-1">Results</p>
                        <p class="text-lg font-bold text-slate-900" id="fb-results">--</p>
                        <p class="text-xs mt-1 hidden" id="fb-results-change"></p>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-xl">
                        <p class="text-xs text-slate-500 mb-1">CPR</p>
                        <p class="text-lg font-bold text-slate-900" id="fb-cpr">--</p>
                        <p class="text-xs mt-1 hidden" id="fb-cpr-change"></p>
                    </div>
                </div>
            </div>

            <!-- Instagram Card -->
            <div class="glass-card rounded-2xl p-6 border-l-4 border-pink-500">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-tr from-purple-500 via-pink-500 to-orange-400 flex items-center justify-center">
                        <i class="ph-fill ph-instagram-logo text-2xl text-white"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-slate-900">Instagram</h3>
                        <p class="text-xs text-slate-500">Hiệu suất quảng cáo IG</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="ig-kpis">
                    <div class="text-center p-3 bg-slate-50 rounded-xl">
                        <p class="text-xs text-slate-500 mb-1">Chi tiêu</p>
                        <p class="text-lg font-bold text-slate-900" id="ig-spend">--</p>
                        <p class="text-xs mt-1 hidden" id="ig-spend-change"></p>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-xl">
                        <p class="text-xs text-slate-500 mb-1">Impressions</p>
                        <p class="text-lg font-bold text-slate-900" id="ig-impressions">--</p>
                        <p class="text-xs mt-1 hidden" id="ig-impressions-change"></p>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-xl">
                        <p class="text-xs text-slate-500 mb-1">Results</p>
                        <p class="text-lg font-bold text-slate-900" id="ig-results">--</p>
                        <p class="text-xs mt-1 hidden" id="ig-results-change"></p>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-xl">
                        <p class="text-xs text-slate-500 mb-1">CPR</p>
                        <p class="text-lg font-bold text-slate-900" id="ig-cpr">--</p>
                        <p class="text-xs mt-1 hidden" id="ig-cpr-change"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SECTION 2: OBJECTIVE (Mess / Impression / Visit) ========== -->
        <div class="fade-in-up delay-200 mt-10">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-1 h-8 bg-gradient-to-b from-purple-500 via-teal-500 to-amber-500 rounded-full"></div>
                <div>
                    <h2 class="text-xl font-bold text-slate-900">Theo Mục tiêu (Objective)</h2>
                    <p class="text-slate-500 text-sm">Message / Impression / Visit IG</p>
                </div>
            </div>
        </div>

        <!-- Objective KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in-up delay-200">
            <!-- Message Card -->
            <div class="glass-card rounded-2xl p-5 border-t-4 border-purple-500">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                        <i class="ph-fill ph-chat-circle-dots text-xl text-purple-600"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-900">Message</h3>
                        <p class="text-xs text-slate-500">Tin nhắn</p>
                    </div>
                </div>
                <div class="space-y-3" id="mess-kpis">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Chi tiêu</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="mess-spend">--</span>
                            <span class="text-xs ml-1 hidden" id="mess-spend-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Impressions</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="mess-impressions">--</span>
                            <span class="text-xs ml-1 hidden" id="mess-impressions-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Results</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="mess-results">--</span>
                            <span class="text-xs ml-1 hidden" id="mess-results-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-slate-100">
                        <span class="text-sm text-slate-500">CPR</span>
                        <div class="text-right">
                            <span class="font-bold text-purple-600" id="mess-cpr">--</span>
                            <span class="text-xs ml-1 hidden" id="mess-cpr-change"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Impression Card -->
            <div class="glass-card rounded-2xl p-5 border-t-4 border-teal-500">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-teal-100 flex items-center justify-center">
                        <i class="ph-fill ph-eye text-xl text-teal-600"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-900">Impression</h3>
                        <p class="text-xs text-slate-500">Hiển thị</p>
                    </div>
                </div>
                <div class="space-y-3" id="impr-kpis">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Chi tiêu</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="impr-spend">--</span>
                            <span class="text-xs ml-1 hidden" id="impr-spend-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Impressions</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="impr-impressions">--</span>
                            <span class="text-xs ml-1 hidden" id="impr-impressions-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Results</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="impr-results">--</span>
                            <span class="text-xs ml-1 hidden" id="impr-results-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-slate-100">
                        <span class="text-sm text-slate-500">CPM</span>
                        <div class="text-right">
                            <span class="font-bold text-teal-600" id="impr-cpm">--</span>
                            <span class="text-xs ml-1 hidden" id="impr-cpm-change"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visit IG Card -->
            <div class="glass-card rounded-2xl p-5 border-t-4 border-amber-500">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center">
                        <i class="ph-fill ph-cursor-click text-xl text-amber-600"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-900">Visit IG</h3>
                        <p class="text-xs text-slate-500">Lượt truy cập IG</p>
                    </div>
                </div>
                <div class="space-y-3" id="visit-kpis">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Chi tiêu</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="visit-spend">--</span>
                            <span class="text-xs ml-1 hidden" id="visit-spend-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Impressions</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="visit-impressions">--</span>
                            <span class="text-xs ml-1 hidden" id="visit-impressions-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Results</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="visit-results">--</span>
                            <span class="text-xs ml-1 hidden" id="visit-results-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-slate-100">
                        <span class="text-sm text-slate-500">CPR</span>
                        <div class="text-right">
                            <span class="font-bold text-amber-600" id="visit-cpr">--</span>
                            <span class="text-xs ml-1 hidden" id="visit-cpr-change"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SECTION 3: COMPARISON CHARTS ========== -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in-up delay-300 mt-10">
            <!-- Channel Chart -->
            <div class="glass-card rounded-2xl p-6">
                <div class="mb-6">
                    <h3 class="font-bold text-slate-900">So sánh Channel</h3>
                    <p class="text-xs text-slate-500">Chi tiêu Facebook vs Instagram</p>
                </div>
                <div class="chart-container" style="height: 280px;">
                    <canvas id="chartChannel"></canvas>
                </div>
            </div>

            <!-- Objective Chart -->
            <div class="glass-card rounded-2xl p-6">
                <div class="mb-6">
                    <h3 class="font-bold text-slate-900">So sánh Objective</h3>
                    <p class="text-xs text-slate-500">Message / Impression / Visit</p>
                </div>
                <div class="chart-container" style="height: 280px;">
                    <canvas id="chartObjective"></canvas>
                </div>
            </div>
        </div>

        <!-- ========== SECTION 4: DETAILED TABLE ========== -->
        <div class="glass-card rounded-2xl overflow-hidden fade-in-up delay-400 mt-6">
            <div class="px-6 py-5 border-b border-slate-100">
                <h3 class="font-bold text-slate-900">Chi tiết theo Campaign</h3>
                <p class="text-xs text-slate-500 mt-1">Bảng phân tích chi tiết theo kênh và mục tiêu</p>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50/50 font-semibold">
                        <tr>
                            <th class="px-6 py-3">Campaign</th>
                            <th class="px-6 py-3">Channel</th>
                            <th class="px-6 py-3">Objective</th>
                            <th class="px-6 py-3 text-right">Chi tiêu</th>
                            <th class="px-6 py-3 text-right">Impressions</th>
                            <th class="px-6 py-3 text-right">Results</th>
                            <th class="px-6 py-3 text-right">CPR</th>
                            <th class="px-6 py-3 text-right">CPM</th>
                        </tr>
                    </thead>
                    <tbody id="breakdownTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="8" class="px-6 py-8 text-center text-slate-400">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 4. Trend Charts Area -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in-up delay-300">
            <!-- Trend Chart -->
            <div class="lg:col-span-2 glass-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="font-bold text-slate-900">Xu hướng chi tiêu</h3>
                        <p class="text-xs text-slate-500">Chi tiêu vs. Hiển thị theo ngày</p>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex items-center gap-2 text-xs text-slate-600">
                            <span class="w-2 h-2 rounded-full bg-brand-500"></span> Chi tiêu
                        </div>
                        <div class="flex items-center gap-2 text-xs text-slate-600">
                            <span class="w-2 h-2 rounded-full bg-accent-blue opacity-50"></span> Impressions
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="chartTrend"></canvas>
                </div>
            </div>

            <!-- Campaign Donut -->
            <div class="glass-card rounded-2xl p-6">
                <div class="mb-6">
                    <h3 class="font-bold text-slate-900">Top Chiến dịch</h3>
                    <p class="text-xs text-slate-500">Phân bổ ngân sách theo campaign</p>
                </div>
                <div class="chart-container" style="height: 280px;">
                    <canvas id="chartCampaigns"></canvas>
                </div>
            </div>
        </div>

        <!-- 3. Demographics & Region -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in-up delay-400">
            <!-- Age & Gender -->
            <div class="glass-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="font-bold text-slate-900">Nhân khẩu học</h3>
                    <div class="flex bg-slate-100 rounded-lg p-1 text-xs font-medium">
                        <button class="px-3 py-1 bg-white rounded shadow-sm text-slate-800">Tuổi & Giới tính</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="chartDemographics"></canvas>
                </div>
            </div>

            <!-- Regions -->
            <div class="glass-card rounded-2xl p-6">
                <div class="mb-6">
                    <h3 class="font-bold text-slate-900">Khu vực địa lý</h3>
                    <p class="text-xs text-slate-500">Top tỉnh/thành phố chi tiêu cao nhất</p>
                </div>
                <div class="chart-container">
                    <canvas id="chartRegions"></canvas>
                </div>
            </div>
        </div>

        <!-- 4. Data Table -->
        <div class="glass-card rounded-2xl overflow-hidden fade-in-up delay-400">
            <div class="px-6 py-5 border-b border-slate-100 flex items-center justify-between">
                <h3 class="font-bold text-slate-900">Chi tiết chiến dịch</h3>
                <button
                    class="text-brand-600 hover:text-brand-700 text-sm font-medium flex items-center gap-1 transition-colors">
                    Export CSV <i class="ph ph-download-simple"></i>
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50/50 font-semibold">
                        <tr>
                            <th class="px-6 py-3">Campaign Name</th>
                            <th class="px-6 py-3 text-right">Chi tiêu</th>
                            <th class="px-6 py-3 text-right">Impressions</th>
                            <th class="px-6 py-3 text-right">Results</th>
                            <th class="px-6 py-3 text-right">CPR</th>
                            <th class="px-6 py-3 text-right">CPM</th>
                        </tr>
                    </thead>
                    <tbody id="campaignTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-slate-400">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="mt-auto border-t border-slate-200 bg-white/50 backdrop-blur-sm">
        <div class="max-w-7xl mx-auto px-4 py-6 text-center text-xs text-slate-400">
            <p>&copy; 2024 Parfumelite Analytics. Powered by Cloudflare D1 & Workers.</p>
        </div>
    </footer>

    <!-- Logic Script -->
    <script>
        // --- CONFIG & STATE ---
        const API_BASE = 'https://parfumelite-dashboard.duongthien408.workers.dev'; // Worker API URL
        let chartInstances = {};

        let state = {
            startDate: null,
            endDate: null,
            compare: false
        };

        // Brand Palette
        const colors = {
            teal: '#14b8a6',
            tealLight: '#ccfbf1',
            blue: '#3b82f6',
            purple: '#8b5cf6',
            rose: '#f43f5e',
            amber: '#f59e0b',
            slate: '#64748b',
            chartPalette: ['#14b8a6', '#8b5cf6', '#f59e0b', '#3b82f6', '#f43f5e', '#64748b']
        };

        // --- FETCH UTILS ---
        async function fetchData(endpoint, params = {}) {
            try {
                const url = new URL(`${API_BASE}${endpoint}`);
                if (state.startDate && state.endDate) {
                    url.searchParams.append('startDate', state.startDate);
                    url.searchParams.append('endDate', state.endDate);
                }
                if (state.compare) {
                    url.searchParams.append('compare', 'true');
                }
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

                const res = await fetch(url);
                const json = await res.json();
                return json.success ? json.data : null;
            } catch (e) {
                console.error("API Error", e);
                return null;
            }
        }

        // Calculate previous period dates
        function getPreviousPeriod(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const duration = end - start;

            const prevEnd = new Date(start.getTime() - 86400000); // 1 day before start
            const prevStart = new Date(prevEnd.getTime() - duration);

            const fmt = d => {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            return { startDate: fmt(prevStart), endDate: fmt(prevEnd) };
        }

        // Fetch with custom dates (for comparison)
        async function fetchDataWithDates(endpoint, startDate, endDate, params = {}) {
            try {
                const url = new URL(`${API_BASE}${endpoint}`);
                url.searchParams.append('startDate', startDate);
                url.searchParams.append('endDate', endDate);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

                const res = await fetch(url);
                const json = await res.json();
                return json.success ? json.data : null;
            } catch (e) {
                console.error("API Error", e);
                return null;
            }
        }

        async function refreshData() {
            // Loading State
            document.body.style.cursor = 'wait';

            // Parallel Fetch - current period
            const [overview, daily, campaigns, demo, regions, breakdown] = await Promise.all([
                fetchData('/api/overview'),
                fetchData('/api/daily'),
                fetchData('/api/campaigns', { limit: 5 }),
                fetchData('/api/demographics'),
                fetchData('/api/regions', { limit: 10 }),
                fetchData('/api/breakdown')
            ]);

            // Fetch comparison data if enabled
            let comparisonBreakdown = null;
            if (state.compare && state.startDate && state.endDate) {
                const prevPeriod = getPreviousPeriod(state.startDate, state.endDate);
                comparisonBreakdown = await fetchDataWithDates('/api/breakdown', prevPeriod.startDate, prevPeriod.endDate);
            }

            // overview không còn dùng vì đã hiển thị theo Channel & Objective
            if (daily) updateTrendChart(daily);
            if (campaigns) {
                updateCampaignChart(campaigns);
                updateTable(campaigns);
            }
            if (demo) updateDemoChart(demo);
            if (regions) updateRegionChart(regions);
            if (breakdown) {
                updateChannelKPIs(breakdown.by_channel, comparisonBreakdown?.by_channel);
                updateObjectiveKPIs(breakdown.by_objective, comparisonBreakdown?.by_objective);
                updateChannelChart(breakdown.by_channel);
                updateObjectiveChart(breakdown.by_objective);
                updateBreakdownTable(breakdown.by_campaign);
            }

            document.body.style.cursor = 'default';
        }

        // --- UPDATERS ---

        // Update Channel KPIs (FB vs IG)
        function updateChannelKPIs(data, comparisonData) {
            // Find Facebook and Instagram data
            const fbData = data.find(d => d.channel === 'Facebook') || {};
            const igData = data.find(d => d.channel === 'Instagram') || {};

            // Find comparison data
            const fbPrev = comparisonData?.find(d => d.channel === 'Facebook') || {};
            const igPrev = comparisonData?.find(d => d.channel === 'Instagram') || {};

            // Update Facebook KPIs
            document.getElementById('fb-spend').textContent = formatCurrency(fbData.total_spend || 0);
            document.getElementById('fb-impressions').textContent = formatNumber(fbData.total_impressions || 0);
            document.getElementById('fb-results').textContent = formatNumber(fbData.total_results || 0);
            document.getElementById('fb-cpr').textContent = formatCurrency(fbData.cpr || 0);

            // Update Facebook comparison
            updateChangeEl('fb-spend-change', fbData.total_spend, fbPrev.total_spend);
            updateChangeEl('fb-impressions-change', fbData.total_impressions, fbPrev.total_impressions);
            updateChangeEl('fb-results-change', fbData.total_results, fbPrev.total_results);
            updateChangeEl('fb-cpr-change', fbData.cpr, fbPrev.cpr, true); // inverse - lower CPR is better

            // Update Instagram KPIs
            document.getElementById('ig-spend').textContent = formatCurrency(igData.total_spend || 0);
            document.getElementById('ig-impressions').textContent = formatNumber(igData.total_impressions || 0);
            document.getElementById('ig-results').textContent = formatNumber(igData.total_results || 0);
            document.getElementById('ig-cpr').textContent = formatCurrency(igData.cpr || 0);

            // Update Instagram comparison
            updateChangeEl('ig-spend-change', igData.total_spend, igPrev.total_spend);
            updateChangeEl('ig-impressions-change', igData.total_impressions, igPrev.total_impressions);
            updateChangeEl('ig-results-change', igData.total_results, igPrev.total_results);
            updateChangeEl('ig-cpr-change', igData.cpr, igPrev.cpr, true); // inverse
        }

        // Update Objective KPIs (Message / Impression / Visit)
        function updateObjectiveKPIs(data, comparisonData) {
            // Find each objective data
            const messData = data.find(d => d.objective === 'Message') || {};
            const imprData = data.find(d => d.objective === 'Impression') || {};
            const visitData = data.find(d => d.objective === 'Visit') || {};

            // Find comparison data
            const messPrev = comparisonData?.find(d => d.objective === 'Message') || {};
            const imprPrev = comparisonData?.find(d => d.objective === 'Impression') || {};
            const visitPrev = comparisonData?.find(d => d.objective === 'Visit') || {};

            // Update Message KPIs
            document.getElementById('mess-spend').textContent = formatCurrency(messData.total_spend || 0);
            document.getElementById('mess-impressions').textContent = formatNumber(messData.total_impressions || 0);
            document.getElementById('mess-results').textContent = formatNumber(messData.total_results || 0);
            document.getElementById('mess-cpr').textContent = formatCurrency(messData.cpr || 0);

            // Update Message comparison
            updateChangeEl('mess-spend-change', messData.total_spend, messPrev.total_spend);
            updateChangeEl('mess-impressions-change', messData.total_impressions, messPrev.total_impressions);
            updateChangeEl('mess-results-change', messData.total_results, messPrev.total_results);
            updateChangeEl('mess-cpr-change', messData.cpr, messPrev.cpr, true);

            // Update Impression KPIs
            document.getElementById('impr-spend').textContent = formatCurrency(imprData.total_spend || 0);
            document.getElementById('impr-impressions').textContent = formatNumber(imprData.total_impressions || 0);
            document.getElementById('impr-results').textContent = formatNumber(imprData.total_results || 0);
            document.getElementById('impr-cpm').textContent = formatCurrency(imprData.cpm || 0);

            // Update Impression comparison
            updateChangeEl('impr-spend-change', imprData.total_spend, imprPrev.total_spend);
            updateChangeEl('impr-impressions-change', imprData.total_impressions, imprPrev.total_impressions);
            updateChangeEl('impr-results-change', imprData.total_results, imprPrev.total_results);
            updateChangeEl('impr-cpm-change', imprData.cpm, imprPrev.cpm, true);

            // Update Visit KPIs
            document.getElementById('visit-spend').textContent = formatCurrency(visitData.total_spend || 0);
            document.getElementById('visit-impressions').textContent = formatNumber(visitData.total_impressions || 0);
            document.getElementById('visit-results').textContent = formatNumber(visitData.total_results || 0);
            document.getElementById('visit-cpr').textContent = formatCurrency(visitData.cpr || 0);

            // Update Visit comparison
            updateChangeEl('visit-spend-change', visitData.total_spend, visitPrev.total_spend);
            updateChangeEl('visit-impressions-change', visitData.total_impressions, visitPrev.total_impressions);
            updateChangeEl('visit-results-change', visitData.total_results, visitPrev.total_results);
            updateChangeEl('visit-cpr-change', visitData.cpr, visitPrev.cpr, true);
        }

        function updateTable(data) {
            const tbody = document.getElementById('campaignTable');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-400">Không có dữ liệu</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(row => `
                <tr class="hover:bg-slate-50 transition-colors group">
                    <td class="px-6 py-4 font-medium text-slate-900 group-hover:text-brand-600 transition-colors">
                        ${row.campaign_name}
                        <div class="text-[10px] text-slate-400 font-normal uppercase tracking-wider">${row.objective}</div>
                    </td>
                    <td class="px-6 py-4 text-right tabular-nums">${formatCurrency(row.total_spend)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${formatNumber(row.total_impressions)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${formatNumber(row.total_results)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${formatCurrency(row.cpr)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${formatCurrency(row.cpm)}</td>
                </tr>
            `).join('');
        }

        // --- CHARTS ---

        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#64748b';
        Chart.defaults.scale.grid.color = '#f1f5f9';

        function updateTrendChart(dataPayload) {
            const ctx = document.getElementById('chartTrend').getContext('2d');
            if (chartInstances.trend) chartInstances.trend.destroy();

            // Handle Comparison structure vs Simple structure
            let currentData = Array.isArray(dataPayload) ? dataPayload : dataPayload.current;
            let comparisonData = (!Array.isArray(dataPayload) && dataPayload.comparison) ? dataPayload.comparison : null;

            // Gradient Fill
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(20, 184, 166, 0.2)');
            gradient.addColorStop(1, 'rgba(20, 184, 166, 0)');

            const datasets = [
                {
                    label: 'Chi tiêu (Kỳ này)',
                    data: currentData.map(d => d.spend),
                    borderColor: colors.teal,
                    backgroundColor: gradient,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y'
                }
            ];

            if (comparisonData && state.compare) {
                datasets.push({
                    label: 'Chi tiêu (Kỳ trước)',
                    data: comparisonData.map(d => d.spend),
                    borderColor: colors.slate,
                    borderWidth: 2,
                    borderDash: [4, 4],
                    tension: 0.4,
                    pointRadius: 0,
                    yAxisID: 'y'
                });
            }

            chartInstances.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentData.map(d => formatDate(d.full_date)),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: state.compare } }, // Show legend only if comparing
                    scales: {
                        y: { type: 'linear', position: 'left', beginAtZero: true },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateCampaignChart(data) {
            const ctx = document.getElementById('chartCampaigns').getContext('2d');
            if (chartInstances.campaigns) chartInstances.campaigns.destroy();

            chartInstances.campaigns = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.campaign_name),
                    datasets: [{
                        data: data.map(d => d.total_spend),
                        backgroundColor: colors.chartPalette,
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true } }
                    }
                }
            });
        }

        function updateDemoChart(data) {
            // Combine Age and Gender for a stacked bar or just show Age for simplicity in this demo
            const ctx = document.getElementById('chartDemographics').getContext('2d');
            if (chartInstances.demo) chartInstances.demo.destroy();

            const ageData = data.by_age;

            chartInstances.demo = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ageData.map(d => d.age_range),
                    datasets: [{
                        label: 'Chi tiêu',
                        data: ageData.map(d => d.spend),
                        backgroundColor: colors.purple,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateRegionChart(data) {
            const ctx = document.getElementById('chartRegions').getContext('2d');
            if (chartInstances.regions) chartInstances.regions.destroy();

            chartInstances.regions = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.region_name),
                    datasets: [{
                        label: 'Chi tiêu',
                        data: data.map(d => d.spend),
                        backgroundColor: colors.amber,
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        // Channel Chart (FB vs IG)
        function updateChannelChart(data) {
            const ctx = document.getElementById('chartChannel').getContext('2d');
            if (chartInstances.channel) chartInstances.channel.destroy();

            const channelColors = {
                'Facebook': '#1877F2',
                'Instagram': '#E4405F',
                'Other': '#64748b'
            };

            chartInstances.channel = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.channel),
                    datasets: [{
                        data: data.map(d => d.total_spend),
                        backgroundColor: data.map(d => channelColors[d.channel] || colors.slate),
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, usePointStyle: true, padding: 15 } }
                    }
                }
            });
        }

        // Objective Chart (Mess / Impression / Visit)
        function updateObjectiveChart(data) {
            const ctx = document.getElementById('chartObjective').getContext('2d');
            if (chartInstances.objective) chartInstances.objective.destroy();

            const objectiveColors = {
                'Message': '#8b5cf6',
                'Impression': '#14b8a6',
                'Visit': '#f59e0b',
                'Unknown': '#64748b'
            };

            chartInstances.objective = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.objective),
                    datasets: [{
                        label: 'Chi tiêu',
                        data: data.map(d => d.total_spend),
                        backgroundColor: data.map(d => objectiveColors[d.objective] || colors.slate),
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // Breakdown Table
        function updateBreakdownTable(data) {
            const tbody = document.getElementById('breakdownTable');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-slate-400">Không có dữ liệu</td></tr>';
                return;
            }

            const channelBadge = (channel) => {
                if (channel === 'Facebook') return '<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded-full">FB</span>';
                if (channel === 'Instagram') return '<span class="px-2 py-1 text-xs font-medium bg-pink-100 text-pink-700 rounded-full">IG</span>';
                return '<span class="px-2 py-1 text-xs font-medium bg-slate-100 text-slate-700 rounded-full">Other</span>';
            };

            const objectiveBadge = (obj) => {
                if (obj === 'Message') return '<span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-700 rounded-full">Mess</span>';
                if (obj === 'Impression') return '<span class="px-2 py-1 text-xs font-medium bg-teal-100 text-teal-700 rounded-full">Impr</span>';
                if (obj === 'Visit') return '<span class="px-2 py-1 text-xs font-medium bg-amber-100 text-amber-700 rounded-full">Visit</span>';
                return '<span class="px-2 py-1 text-xs font-medium bg-slate-100 text-slate-700 rounded-full">' + obj + '</span>';
            };

            tbody.innerHTML = data.map(row => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 font-medium text-slate-900">${row.campaign_name}</td>
                    <td class="px-6 py-4">${channelBadge(row.channel)}</td>
                    <td class="px-6 py-4">${objectiveBadge(row.objective)}</td>
                    <td class="px-6 py-4 text-right tabular-nums font-medium">${formatCurrency(row.total_spend)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${formatNumber(row.total_impressions)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${formatNumber(row.total_results)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${formatCurrency(row.cpr || 0)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${formatCurrency(row.cpm || 0)}</td>
                </tr>
            `).join('');
        }

        // --- FORMATTERS ---
        const formatCurrency = (val) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 }).format(val);
        const formatNumber = (val) => new Intl.NumberFormat('vi-VN').format(val);
        const formatDate = (str) => {
            // Parse date string as local date (not UTC) to avoid timezone offset issues
            const parts = str.split('-');
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const day = parseInt(parts[2], 10);
            return `${day}/${month}`;
        }

        // Calculate percentage change
        function calcChange(current, previous) {
            if (!previous || previous === 0) return null;
            return ((current - previous) / previous) * 100;
        }

        // Format change badge
        function formatChangeBadge(change, inverse = false) {
            if (change === null) return '';
            const isPositive = inverse ? change < 0 : change > 0;
            const arrow = change > 0 ? '↑' : '↓';
            const colorClass = isPositive ? 'text-green-600' : 'text-red-500';
            return `<span class="${colorClass}">${arrow} ${Math.abs(change).toFixed(1)}%</span>`;
        }

        // Update change element
        function updateChangeEl(elementId, current, previous, inverse = false) {
            const el = document.getElementById(elementId);
            if (!el) return;

            if (state.compare && previous !== undefined) {
                const change = calcChange(current, previous);
                if (change !== null) {
                    el.innerHTML = formatChangeBadge(change, inverse);
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            } else {
                el.classList.add('hidden');
            }
        }

        // --- INIT & EVENTS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Flatpickr
            flatpickr("#datePickerBtn", {
                mode: "range",
                dateFormat: "Y-m-d",
                defaultDate: [new Date().setDate(new Date().getDate() - 30), new Date()],
                locale: "vn", // Would need locale script, default English for now
                onChange: function (selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        const start = selectedDates[0];
                        const end = selectedDates[1];
                        // Format to YYYY-MM-DD using local date (avoid timezone issues)
                        const fmt = d => {
                            const year = d.getFullYear();
                            const month = String(d.getMonth() + 1).padStart(2, '0');
                            const day = String(d.getDate()).padStart(2, '0');
                            return `${year}-${month}-${day}`;
                        };
                        state.startDate = fmt(start);
                        state.endDate = fmt(end);

                        // Update Button Text
                        document.getElementById('dateText').innerText = `${formatDate(state.startDate)} - ${formatDate(state.endDate)}`;

                        refreshData();
                    }
                }
            });

            // Set initial state - use local date format to avoid timezone issues
            const formatLocalDate = d => {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - 30);
            state.startDate = formatLocalDate(start);
            state.endDate = formatLocalDate(end);
            document.getElementById('dateText').innerText = `${formatDate(state.startDate)} - ${formatDate(state.endDate)}`;

            // Toggle Comparison
            document.getElementById('compareToggle').addEventListener('change', (e) => {
                state.compare = e.target.checked;
                refreshData();
            });

            refreshData();
        });


    </script>
</body>

</html>
```