<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parfumelite Analytics</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/vn.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            500: '#14b8a6', // Teal main
                            600: '#0d9488',
                            900: '#134e4a',
                        },
                        accent: {
                            purple: '#8b5cf6',
                            rose: '#f43f5e',
                            amber: '#f59e0b',
                            blue: '#3b82f6'
                        }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
                    },
                    backdropBlur: {
                        'xs': '2px',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
            background-image:
                radial-gradient(at 0% 0%, rgba(20, 184, 166, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.1) 0px, transparent 50%);
        }

        /* Glassmorphism Card Utils */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
        }

        /* Animations */
        .fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .delay-100 {
            animation-delay: 100ms;
        }

        .delay-200 {
            animation-delay: 200ms;
        }

        .delay-300 {
            animation-delay: 300ms;
        }

        .delay-400 {
            animation-delay: 400ms;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body class="text-slate-800 antialiased min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass-header">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-gradient-to-tr from-brand-500 to-accent-purple flex items-center justify-center text-white shadow-lg shadow-brand-500/20">
                        <i class="ph ph-chart-polar text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-xl tracking-tight text-slate-900 leading-tight">Parfumelite</h1>
                        <p class="text-xs text-slate-500 font-medium">Analytics Dashboard</p>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-4">
                    <!-- Comparison Switch -->
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="compareToggle" class="sr-only peer">
                        <div
                            class="relative w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-brand-500">
                        </div>
                        <span class="ms-2 text-sm font-medium text-slate-600">Compare</span>
                    </label>

                    <!-- Date Picker Button -->
                    <button id="datePickerBtn"
                        class="flex items-center gap-2 bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-xl text-sm font-medium hover:bg-slate-50 transition-all shadow-sm">
                        <i class="ph ph-calendar-blank text-lg"></i>
                        <span id="dateText">Last 30 days</span>
                        <i class="ph ph-caret-down text-slate-400"></i>
                    </button>

                    <button onclick="refreshData()"
                        class="flex items-center gap-2 bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-xl text-sm font-medium transition-all shadow-lg shadow-slate-900/10 active:scale-95">
                        <i class="ph ph-arrows-clockwise"></i>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full space-y-8">

        <!-- ========== SECTION 1: CHANNEL (FB vs IG) ========== -->
        <div class="fade-in-up">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-1 h-8 bg-gradient-to-b from-blue-500 to-pink-500 rounded-full"></div>
                <div>
                    <h2 class="text-xl font-bold text-slate-900">By Channel</h2>
                    <p class="text-slate-500 text-sm">Facebook vs Instagram</p>
                </div>
            </div>
        </div>

        <!-- Channel Summary Card -->
        <div class="glass-card rounded-2xl p-6 fade-in-up delay-100">
            <!-- Row 1: Chi tiêu -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Tổng chi tiêu -->
                <div class="text-center p-4 bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl">
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-pink-500 flex items-center justify-center">
                            <i class="ph-fill ph-currency-circle-dollar text-xl text-white"></i>
                        </div>
                    </div>
                    <p class="text-sm text-slate-500 mb-1">Total Spend</p>
                    <p class="text-2xl font-bold text-slate-900" id="channel-total-spend">--</p>
                    <p class="text-xs mt-1 hidden" id="channel-total-spend-change"></p>
                </div>

                <!-- Chi tiêu Facebook -->
                <div class="text-center p-4 bg-blue-50 rounded-xl border border-blue-100">
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center">
                            <i class="ph-fill ph-facebook-logo text-xl text-white"></i>
                        </div>
                    </div>
                    <p class="text-sm text-slate-500 mb-1">Facebook Spend</p>
                    <p class="text-2xl font-bold text-blue-600" id="fb-spend">--</p>
                    <p class="text-xs mt-1 hidden" id="fb-spend-change"></p>
                </div>

                <!-- Chi tiêu Instagram -->
                <div class="text-center p-4 bg-pink-50 rounded-xl border border-pink-100">
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-purple-500 via-pink-500 to-orange-400 flex items-center justify-center">
                            <i class="ph-fill ph-instagram-logo text-xl text-white"></i>
                        </div>
                    </div>
                    <p class="text-sm text-slate-500 mb-1">Instagram Spend</p>
                    <p class="text-2xl font-bold text-pink-600" id="ig-spend">--</p>
                    <p class="text-xs mt-1 hidden" id="ig-spend-change"></p>
                </div>
            </div>

            <!-- Divider -->
            <div class="border-t border-slate-200 my-4"></div>

            <!-- Row 2: Kết quả -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Tổng tin nhắn -->
                <div class="flex items-center gap-4 p-4 bg-purple-50 rounded-xl border border-purple-100">
                    <div class="w-12 h-12 rounded-xl bg-purple-500 flex items-center justify-center flex-shrink-0">
                        <i class="ph-fill ph-chat-circle-dots text-2xl text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">Messages</p>
                        <p class="text-xl font-bold text-purple-600" id="channel-total-messages">--</p>
                        <p class="text-xs hidden" id="channel-total-messages-change"></p>
                    </div>
                </div>

                <!-- Tổng hiển thị -->
                <div class="flex items-center gap-4 p-4 bg-teal-50 rounded-xl border border-teal-100">
                    <div class="w-12 h-12 rounded-xl bg-teal-500 flex items-center justify-center flex-shrink-0">
                        <i class="ph-fill ph-eye text-2xl text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">Impressions</p>
                        <p class="text-xl font-bold text-teal-600" id="channel-total-impressions">--</p>
                        <p class="text-xs hidden" id="channel-total-impressions-change"></p>
                    </div>
                </div>

                <!-- Visit Profile -->
                <div class="flex items-center gap-4 p-4 bg-amber-50 rounded-xl border border-amber-100">
                    <div class="w-12 h-12 rounded-xl bg-amber-500 flex items-center justify-center flex-shrink-0">
                        <i class="ph-fill ph-user-focus text-2xl text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">Visit Profile IG</p>
                        <p class="text-xl font-bold text-amber-600" id="channel-total-visits">--</p>
                        <p class="text-xs hidden" id="channel-total-visits-change"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SECTION 2: OBJECTIVE (Mess / Impression / Visit) ========== -->
        <div class="fade-in-up delay-200 mt-10">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-1 h-8 bg-gradient-to-b from-purple-500 via-teal-500 to-amber-500 rounded-full"></div>
                <div>
                    <h2 class="text-xl font-bold text-slate-900">By Objective</h2>
                    <p class="text-slate-500 text-sm">Message / Impression / Visit IG</p>
                </div>
            </div>
        </div>

        <!-- Objective KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in-up delay-200">
            <!-- Message Card -->
            <div class="glass-card rounded-2xl p-5 border-t-4 border-purple-500">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                        <i class="ph-fill ph-chat-circle-dots text-xl text-purple-600"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-900">Message</h3>
                        <p class="text-xs text-slate-500">Messages</p>
                    </div>
                </div>
                <div class="space-y-3" id="mess-kpis">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Spend</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="mess-spend">--</span>
                            <span class="text-xs ml-1 hidden" id="mess-spend-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Impressions</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="mess-impressions">--</span>
                            <span class="text-xs ml-1 hidden" id="mess-impressions-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Results</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="mess-results">--</span>
                            <span class="text-xs ml-1 hidden" id="mess-results-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-slate-100">
                        <span class="text-sm text-slate-500">CPR</span>
                        <div class="text-right">
                            <span class="font-bold text-purple-600" id="mess-cpr">--</span>
                            <span class="text-xs ml-1 hidden" id="mess-cpr-change"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Impression Card -->
            <div class="glass-card rounded-2xl p-5 border-t-4 border-teal-500">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-teal-100 flex items-center justify-center">
                        <i class="ph-fill ph-eye text-xl text-teal-600"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-900">Impression</h3>
                        <p class="text-xs text-slate-500">Display Ads</p>
                    </div>
                </div>
                <div class="space-y-3" id="impr-kpis">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Spend</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="impr-spend">--</span>
                            <span class="text-xs ml-1 hidden" id="impr-spend-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Impressions</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="impr-impressions">--</span>
                            <span class="text-xs ml-1 hidden" id="impr-impressions-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Results</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="impr-results">--</span>
                            <span class="text-xs ml-1 hidden" id="impr-results-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-slate-100">
                        <span class="text-sm text-slate-500">CPM</span>
                        <div class="text-right">
                            <span class="font-bold text-teal-600" id="impr-cpm">--</span>
                            <span class="text-xs ml-1 hidden" id="impr-cpm-change"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visit IG Card -->
            <div class="glass-card rounded-2xl p-5 border-t-4 border-amber-500">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center">
                        <i class="ph-fill ph-cursor-click text-xl text-amber-600"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-900">Visit IG</h3>
                        <p class="text-xs text-slate-500">Profile Visits</p>
                    </div>
                </div>
                <div class="space-y-3" id="visit-kpis">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Spend</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="visit-spend">--</span>
                            <span class="text-xs ml-1 hidden" id="visit-spend-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Impressions</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="visit-impressions">--</span>
                            <span class="text-xs ml-1 hidden" id="visit-impressions-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Results</span>
                        <div class="text-right">
                            <span class="font-bold text-slate-900" id="visit-results">--</span>
                            <span class="text-xs ml-1 hidden" id="visit-results-change"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-slate-100">
                        <span class="text-sm text-slate-500">CPR</span>
                        <div class="text-right">
                            <span class="font-bold text-amber-600" id="visit-cpr">--</span>
                            <span class="text-xs ml-1 hidden" id="visit-cpr-change"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SECTION 4: DETAILED TABLE ========== -->
        <div class="glass-card rounded-2xl overflow-hidden fade-in-up delay-400 mt-6">
            <div class="px-6 py-5 border-b border-slate-100">
                <h3 class="font-bold text-slate-900">Campaign Details</h3>
                <p class="text-xs text-slate-500 mt-1">Detailed breakdown by channel and objective</p>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50/50 font-semibold">
                        <tr>
                            <th class="px-6 py-3">Campaign</th>
                            <th class="px-6 py-3">Channel</th>
                            <th class="px-6 py-3">Objective</th>
                            <th class="px-6 py-3 text-right">Spend</th>
                            <th class="px-6 py-3 text-right">Impressions</th>
                            <th class="px-6 py-3 text-right">Results</th>
                            <th class="px-6 py-3 text-right">CPR</th>
                            <th class="px-6 py-3 text-right">CPM</th>
                        </tr>
                    </thead>
                    <tbody id="breakdownTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="8" class="px-6 py-8 text-center text-slate-400">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========== SECTION: TOP PRODUCT PERFORMANCE ========== -->
        <div class="fade-in-up delay-400 mt-8">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-1 h-8 bg-gradient-to-b from-emerald-500 to-cyan-500 rounded-full"></div>
                <div>
                    <h2 class="text-xl font-bold text-slate-900">Top Performance by Product Line</h2>
                    <p class="text-slate-500 text-sm">Performance by product line</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in-up delay-400">
            <!-- Top Message Products -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="px-5 py-4 border-b border-slate-100 bg-purple-50/50">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-purple-500 flex items-center justify-center">
                            <i class="ph-fill ph-chat-circle-dots text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-900">Top Messages</h3>
                            <p class="text-xs text-slate-500">By Product Line</p>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div id="topMessageProducts" class="space-y-2">
                        <div class="text-center text-slate-400 py-4">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Top Impression Products -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="px-5 py-4 border-b border-slate-100 bg-teal-50/50">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-teal-500 flex items-center justify-center">
                            <i class="ph-fill ph-eye text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-900">Top Impressions</h3>
                            <p class="text-xs text-slate-500">By Product Line</p>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div id="topImpressionProducts" class="space-y-2">
                        <div class="text-center text-slate-400 py-4">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Top Visit Products -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="px-5 py-4 border-b border-slate-100 bg-amber-50/50">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-amber-500 flex items-center justify-center">
                            <i class="ph-fill ph-user-focus text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-900">Top Visit Profile</h3>
                            <p class="text-xs text-slate-500">By Product Line</p>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div id="topVisitProducts" class="space-y-2">
                        <div class="text-center text-slate-400 py-4">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. Trend Charts Area -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in-up delay-300 mt-8">
            <!-- FB Messages Chart -->
            <div class="glass-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="font-bold text-slate-900">FB Messages by Day</h3>
                        <p class="text-xs text-slate-500">Click product to filter</p>
                    </div>
                </div>
                <div id="productLegendFB" class="flex flex-wrap gap-2 mb-4">
                    <!-- Legend will be populated dynamically -->
                </div>
                <div class="chart-container">
                    <canvas id="chartProductDailyFB"></canvas>
                </div>
            </div>

            <!-- IG Messages Chart -->
            <div class="glass-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="font-bold text-slate-900">IG Messages by Day</h3>
                        <p class="text-xs text-slate-500">Click product to filter</p>
                    </div>
                </div>
                <div id="productLegendIG" class="flex flex-wrap gap-2 mb-4">
                    <!-- Legend will be populated dynamically -->
                </div>
                <div class="chart-container">
                    <canvas id="chartProductDailyIG"></canvas>
                </div>
            </div>
        </div>

        <!-- 4. Top Posts Rankings -->
        <div class="fade-in-up delay-400">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-1 h-8 bg-gradient-to-b from-rose-500 to-orange-500 rounded-full"></div>
                <div>
                    <h2 class="text-xl font-bold text-slate-900">Top Posts</h2>
                    <p class="text-slate-500 text-sm">Ranked by conversion performance</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in-up delay-400">
            <!-- Top Messages FB -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="px-5 py-4 border-b border-slate-100 bg-blue-50/50">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center">
                            <i class="ph-fill ph-facebook-logo text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-900">Top FB Messages</h3>
                            <p class="text-xs text-slate-500">Highest Facebook message conversions</p>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div id="topMessagesFB" class="space-y-3">
                        <div class="text-center text-slate-400 py-4">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Top Messages IG -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="px-5 py-4 border-b border-slate-100 bg-pink-50/50">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-tr from-purple-500 via-pink-500 to-orange-400 flex items-center justify-center">
                            <i class="ph-fill ph-instagram-logo text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-900">Top IG Messages</h3>
                            <p class="text-xs text-slate-500">Highest Instagram message conversions</p>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div id="topMessagesIG" class="space-y-3">
                        <div class="text-center text-slate-400 py-4">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Top Impressions -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="px-5 py-4 border-b border-slate-100 bg-teal-50/50">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-teal-500 flex items-center justify-center">
                            <i class="ph-fill ph-eye text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-900">Top Impressions</h3>
                            <p class="text-xs text-slate-500">Highest impression count</p>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div id="topImpressions" class="space-y-3">
                        <div class="text-center text-slate-400 py-4">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Top Visit IG -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="px-5 py-4 border-b border-slate-100 bg-amber-50/50">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-amber-500 flex items-center justify-center">
                            <i class="ph-fill ph-user-focus text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-900">Top Visit Profile IG</h3>
                            <p class="text-xs text-slate-500">Highest Instagram profile visits</p>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div id="topVisitIG" class="space-y-3">
                        <div class="text-center text-slate-400 py-4">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SECTION: DEMOGRAPHIC ========== -->
        <div class="fade-in-up delay-400 mt-8">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-1 h-8 bg-gradient-to-b from-blue-500 to-cyan-500 rounded-full"></div>
                <div>
                    <h2 class="text-xl font-bold text-slate-900">Demographic</h2>
                    <p class="text-slate-500 text-sm">Demographics and geographic analysis</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in-up delay-400">
            <!-- Age & Gender -->
            <div class="glass-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="font-bold text-slate-900">Age & Gender</h3>
                    <div class="flex bg-slate-100 rounded-lg p-1 text-xs font-medium">
                        <button class="px-3 py-1 bg-white rounded shadow-sm text-slate-800">Age & Gender</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="chartDemographics"></canvas>
                </div>
            </div>

            <!-- Regions -->
            <div class="glass-card rounded-2xl p-6">
                <div class="mb-6">
                    <h3 class="font-bold text-slate-900">Geographic Regions</h3>
                    <p class="text-xs text-slate-500">Top provinces/cities by spend</p>
                </div>
                <div class="chart-container">
                    <canvas id="chartRegions"></canvas>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="mt-auto border-t border-slate-200 bg-white/50 backdrop-blur-sm">
        <div class="max-w-7xl mx-auto px-4 py-6 text-center text-xs text-slate-400">
            <p>&copy; 2025 Parfumelite Analytics. Powered by Cloudflare D1 & Workers.</p>
        </div>
    </footer>

    <!-- Logic Script -->
    <script>
        // --- CONFIG & STATE ---
        const API_BASE = 'https://perfume-dashboard-api.duongthien408.workers.dev'; // Worker API URL
        let chartInstances = {};

        let state = {
            startDate: null,
            endDate: null,
            compare: false
        };

        // Brand Palette
        const colors = {
            teal: '#14b8a6',
            tealLight: '#ccfbf1',
            blue: '#3b82f6',
            purple: '#8b5cf6',
            rose: '#f43f5e',
            amber: '#f59e0b',
            slate: '#64748b',
            chartPalette: ['#14b8a6', '#8b5cf6', '#f59e0b', '#3b82f6', '#f43f5e', '#64748b']
        };

        // --- FETCH UTILS ---
        async function fetchData(endpoint, params = {}) {
            try {
                const url = new URL(`${API_BASE}${endpoint}`);
                if (state.startDate && state.endDate) {
                    url.searchParams.append('startDate', state.startDate);
                    url.searchParams.append('endDate', state.endDate);
                }
                if (state.compare) {
                    url.searchParams.append('compare', 'true');
                }
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

                const res = await fetch(url);
                const json = await res.json();
                return json.success ? json.data : null;
            } catch (e) {
                console.error("API Error", e);
                return null;
            }
        }

        // Calculate previous period dates
        function getPreviousPeriod(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const duration = end - start;

            const prevEnd = new Date(start.getTime() - 86400000); // 1 day before start
            const prevStart = new Date(prevEnd.getTime() - duration);

            const fmt = d => {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            return { startDate: fmt(prevStart), endDate: fmt(prevEnd) };
        }

        // Fetch with custom dates (for comparison)
        async function fetchDataWithDates(endpoint, startDate, endDate, params = {}) {
            try {
                const url = new URL(`${API_BASE}${endpoint}`);
                url.searchParams.append('startDate', startDate);
                url.searchParams.append('endDate', endDate);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

                const res = await fetch(url);
                const json = await res.json();
                return json.success ? json.data : null;
            } catch (e) {
                console.error("API Error", e);
                return null;
            }
        }

        async function refreshData() {
            try {
                // Loading State
                document.body.style.cursor = 'wait';
                console.log('Fetching data...', state);

                // Parallel Fetch - current period
                const [demo, regions, breakdown, topAds, topProducts, productDailyFB, productDailyIG] = await Promise.all([
                    fetchData('/api/demographics'),
                    fetchData('/api/regions', { limit: 10 }),
                    fetchData('/api/breakdown'),
                    fetchData('/api/top-ads', { limit: 3 }),
                    fetchData('/api/top-products', { limit: 5 }),
                    fetchData('/api/product-daily-fb', { limit: 5 }),
                    fetchData('/api/product-daily-ig', { limit: 5 })
                ]);

                console.log('Data fetched:', { breakdown, topAds, topProducts, productDailyFB, productDailyIG });

                // Fetch comparison data if enabled
                let comparisonBreakdown = null;
                if (state.compare && state.startDate && state.endDate) {
                    const prevPeriod = getPreviousPeriod(state.startDate, state.endDate);
                    comparisonBreakdown = await fetchDataWithDates('/api/breakdown', prevPeriod.startDate, prevPeriod.endDate);
                }

                if (productDailyFB) updateProductDailyChart(productDailyFB, 'FB');
                if (productDailyIG) updateProductDailyChart(productDailyIG, 'IG');
                if (demo) updateDemoChart(demo);
                if (regions) updateRegionChart(regions);
                if (breakdown) {
                    updateChannelKPIs(breakdown.by_channel, breakdown.by_objective, comparisonBreakdown?.by_channel, comparisonBreakdown?.by_objective);
                    updateObjectiveKPIs(breakdown.by_objective, comparisonBreakdown?.by_objective);
                    updateBreakdownTable(breakdown.by_campaign, comparisonBreakdown?.by_campaign);
                }
                if (topAds) {
                    updateTopAds(topAds);
                }
                if (topProducts) {
                    updateTopProducts(topProducts);
                }

                document.body.style.cursor = 'default';
            } catch (err) {
                console.error('refreshData error:', err);
                document.body.style.cursor = 'default';
            }
        }

        // --- UPDATERS ---

        // Update Channel KPIs (new 6 KPIs layout)
        function updateChannelKPIs(channelData, objectiveData, compChannelData, compObjectiveData) {
            // Find Facebook and Instagram data
            const fbData = channelData.find(d => d.channel === 'Facebook') || {};
            const igData = channelData.find(d => d.channel === 'Instagram') || {};

            // Find objective data for messages and visits
            const messData = objectiveData?.find(d => d.objective === 'Message') || {};
            const visitData = objectiveData?.find(d => d.objective === 'Visit') || {};

            // Find comparison data
            const fbPrev = compChannelData?.find(d => d.channel === 'Facebook') || {};
            const igPrev = compChannelData?.find(d => d.channel === 'Instagram') || {};
            const messPrev = compObjectiveData?.find(d => d.objective === 'Message') || {};
            const visitPrev = compObjectiveData?.find(d => d.objective === 'Visit') || {};

            // Calculate totals
            const totalSpend = (fbData.total_spend || 0) + (igData.total_spend || 0);
            const totalImpressions = (fbData.total_impressions || 0) + (igData.total_impressions || 0);
            const totalSpendPrev = (fbPrev.total_spend || 0) + (igPrev.total_spend || 0);
            const totalImpressionsPrev = (fbPrev.total_impressions || 0) + (igPrev.total_impressions || 0);

            // Update Total Spend
            document.getElementById('channel-total-spend').textContent = formatCurrency(totalSpend);
            updateChangeEl('channel-total-spend-change', totalSpend, totalSpendPrev);

            // Update Facebook Spend
            document.getElementById('fb-spend').textContent = formatCurrency(fbData.total_spend || 0);
            updateChangeEl('fb-spend-change', fbData.total_spend, fbPrev.total_spend);

            // Update Instagram Spend
            document.getElementById('ig-spend').textContent = formatCurrency(igData.total_spend || 0);
            updateChangeEl('ig-spend-change', igData.total_spend, igPrev.total_spend);

            // Update Total Messages (from Message objective results)
            document.getElementById('channel-total-messages').textContent = formatNumber(messData.total_results || 0);
            updateChangeEl('channel-total-messages-change', messData.total_results, messPrev.total_results);

            // Update Total Impressions
            document.getElementById('channel-total-impressions').textContent = formatNumber(totalImpressions);
            updateChangeEl('channel-total-impressions-change', totalImpressions, totalImpressionsPrev);

            // Update Total Visit Profile (from Visit objective results)
            document.getElementById('channel-total-visits').textContent = formatNumber(visitData.total_results || 0);
            updateChangeEl('channel-total-visits-change', visitData.total_results, visitPrev.total_results);
        }

        // Update Objective KPIs (Message / Impression / Visit)
        function updateObjectiveKPIs(data, comparisonData) {
            // Find each objective data
            const messData = data.find(d => d.objective === 'Message') || {};
            const imprData = data.find(d => d.objective === 'Impression') || {};
            const visitData = data.find(d => d.objective === 'Visit') || {};

            // Find comparison data
            const messPrev = comparisonData?.find(d => d.objective === 'Message') || {};
            const imprPrev = comparisonData?.find(d => d.objective === 'Impression') || {};
            const visitPrev = comparisonData?.find(d => d.objective === 'Visit') || {};

            // Update Message KPIs
            document.getElementById('mess-spend').textContent = formatCurrency(messData.total_spend || 0);
            document.getElementById('mess-impressions').textContent = formatNumber(messData.total_impressions || 0);
            document.getElementById('mess-results').textContent = formatNumber(messData.total_results || 0);
            document.getElementById('mess-cpr').textContent = formatCurrency(messData.cpr || 0);

            // Update Message comparison
            updateChangeEl('mess-spend-change', messData.total_spend, messPrev.total_spend);
            updateChangeEl('mess-impressions-change', messData.total_impressions, messPrev.total_impressions);
            updateChangeEl('mess-results-change', messData.total_results, messPrev.total_results);
            updateChangeEl('mess-cpr-change', messData.cpr, messPrev.cpr, true);

            // Update Impression KPIs
            document.getElementById('impr-spend').textContent = formatCurrency(imprData.total_spend || 0);
            document.getElementById('impr-impressions').textContent = formatNumber(imprData.total_impressions || 0);
            document.getElementById('impr-results').textContent = formatNumber(imprData.total_results || 0);
            document.getElementById('impr-cpm').textContent = formatCurrency(imprData.cpm || 0);

            // Update Impression comparison
            updateChangeEl('impr-spend-change', imprData.total_spend, imprPrev.total_spend);
            updateChangeEl('impr-impressions-change', imprData.total_impressions, imprPrev.total_impressions);
            updateChangeEl('impr-results-change', imprData.total_results, imprPrev.total_results);
            updateChangeEl('impr-cpm-change', imprData.cpm, imprPrev.cpm, true);

            // Update Visit KPIs
            document.getElementById('visit-spend').textContent = formatCurrency(visitData.total_spend || 0);
            document.getElementById('visit-impressions').textContent = formatNumber(visitData.total_impressions || 0);
            document.getElementById('visit-results').textContent = formatNumber(visitData.total_results || 0);
            document.getElementById('visit-cpr').textContent = formatCurrency(visitData.cpr || 0);

            // Update Visit comparison
            updateChangeEl('visit-spend-change', visitData.total_spend, visitPrev.total_spend);
            updateChangeEl('visit-impressions-change', visitData.total_impressions, visitPrev.total_impressions);
            updateChangeEl('visit-results-change', visitData.total_results, visitPrev.total_results);
            updateChangeEl('visit-cpr-change', visitData.cpr, visitPrev.cpr, true);
        }

        function updateTable(data) {
            const tbody = document.getElementById('campaignTable');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-400">No data available</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(row => `
                <tr class="hover:bg-slate-50 transition-colors group">
                    <td class="px-6 py-4 font-medium text-slate-900 group-hover:text-brand-600 transition-colors">
                        ${row.campaign_name}
                        <div class="text-[10px] text-slate-400 font-normal uppercase tracking-wider">${row.objective}</div>
                    </td>
                    <td class="px-6 py-4 text-right tabular-nums">${formatCurrency(row.total_spend)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${formatNumber(row.total_impressions)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${formatNumber(row.total_results)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${formatCurrency(row.cpr)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${formatCurrency(row.cpm)}</td>
                </tr>
            `).join('');
        }

        // --- CHARTS ---

        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#64748b';
        Chart.defaults.scale.grid.color = '#f1f5f9';

        // Store product visibility state for FB and IG
        let productVisibilityFB = {};
        let productVisibilityIG = {};

        function updateProductDailyChart(data, channel = 'FB') {
            console.log(`updateProductDailyChart ${channel} called with:`, data);

            if (!data || !data.series || data.series.length === 0) {
                console.log(`No data for product daily chart ${channel}`);
                return;
            }

            // Get the right visibility object and elements based on channel
            const visibility = channel === 'FB' ? productVisibilityFB : productVisibilityIG;
            const canvasId = channel === 'FB' ? 'chartProductDailyFB' : 'chartProductDailyIG';
            const legendId = channel === 'FB' ? 'productLegendFB' : 'productLegendIG';
            const chartKey = channel === 'FB' ? 'productDailyFB' : 'productDailyIG';
            const dataKey = channel === 'FB' ? 'productDailyDataFB' : 'productDailyDataIG';

            // Store data globally for legend toggle
            window[dataKey] = data;

            // Initialize visibility (all visible by default)
            if (Object.keys(visibility).length === 0) {
                data.series.forEach(s => visibility[s.name] = true);
            }

            const ctx = document.getElementById(canvasId).getContext('2d');
            if (chartInstances[chartKey]) chartInstances[chartKey].destroy();

            const productColors = [
                '#14b8a6', // teal
                '#8b5cf6', // purple
                '#f59e0b', // amber
                '#3b82f6', // blue
                '#f43f5e'  // rose
            ];

            // Create datasets from series
            const datasets = data.series
                .map((s, i) => ({
                    label: s.name,
                    data: s.data,
                    borderColor: productColors[i % productColors.length],
                    backgroundColor: productColors[i % productColors.length] + '20',
                    borderWidth: 2.5,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    hidden: !visibility[s.name],
                    colorIndex: i
                }));

            // Update legend with clickable items
            const legendContainer = document.getElementById(legendId);
            if (legendContainer) {
                legendContainer.innerHTML = data.series.map((s, i) => {
                    const isActive = visibility[s.name];
                    return `
                    <div class="flex items-center gap-2 text-xs cursor-pointer select-none transition-opacity ${isActive ? 'opacity-100' : 'opacity-40'}"
                         onclick="toggleProductLine('${s.name}', '${channel}')"
                         title="Click to ${isActive ? 'hide' : 'show'} ${s.name}">
                        <span class="w-3 h-3 rounded-full" style="background-color: ${productColors[i % productColors.length]}"></span>
                        <span class="${isActive ? 'text-slate-700 font-medium' : 'text-slate-400'}">${s.name}</span>
                    </div>
                `}).join('');
            }

            chartInstances[chartKey] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates.map(d => formatDate(d)),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            filter: function(tooltipItem) {
                                return !tooltipItem.dataset.hidden;
                            },
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatNumber(context.raw)} messages`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // Toggle product line visibility
        function toggleProductLine(productName, channel = 'FB') {
            const visibility = channel === 'FB' ? productVisibilityFB : productVisibilityIG;
            const dataKey = channel === 'FB' ? 'productDailyDataFB' : 'productDailyDataIG';

            visibility[productName] = !visibility[productName];
            if (window[dataKey]) {
                updateProductDailyChart(window[dataKey], channel);
            }
        }

        function updateDemoChart(data) {
            const ctx = document.getElementById('chartDemographics').getContext('2d');
            if (chartInstances.demo) chartInstances.demo.destroy();

            // Use by_age_gender for stacked bar chart
            const ageGenderData = data.by_age_gender || [];

            // Get unique age ranges (maintain order)
            const ageRanges = [...new Set(ageGenderData.map(d => d.age_range))];

            // Prepare data for each gender
            const femaleData = ageRanges.map(age => {
                const item = ageGenderData.find(d => d.age_range === age && d.gender === 'female');
                return item ? item.spend : 0;
            });

            const maleData = ageRanges.map(age => {
                const item = ageGenderData.find(d => d.age_range === age && d.gender === 'male');
                return item ? item.spend : 0;
            });

            // Calculate percentages for each age group
            const percentages = ageRanges.map((age, i) => {
                const total = femaleData[i] + maleData[i];
                return {
                    female: total > 0 ? Math.round((femaleData[i] / total) * 100) : 0,
                    male: total > 0 ? Math.round((maleData[i] / total) * 100) : 0
                };
            });

            chartInstances.demo = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ageRanges,
                    datasets: [
                        {
                            label: 'Female',
                            data: femaleData,
                            backgroundColor: '#ec4899',
                            borderRadius: 4,
                            percentages: percentages.map(p => p.female)
                        },
                        {
                            label: 'Male',
                            data: maleData,
                            backgroundColor: '#3b82f6',
                            borderRadius: 4,
                            percentages: percentages.map(p => p.male)
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { boxWidth: 12, usePointStyle: true }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const pct = context.dataset.percentages[context.dataIndex];
                                    return `${context.dataset.label}: ${formatCurrency(value)} (${pct}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, stacked: true },
                        x: { grid: { display: false }, stacked: true }
                    }
                },
                plugins: [{
                    id: 'percentageLabels',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        ctx.save();
                        ctx.font = 'bold 11px Inter, sans-serif';
                        ctx.textAlign = 'center';

                        chart.data.datasets.forEach((dataset, datasetIndex) => {
                            const meta = chart.getDatasetMeta(datasetIndex);
                            meta.data.forEach((bar, index) => {
                                const pct = dataset.percentages[index];
                                if (pct > 8) { // Only show if > 8%
                                    const barHeight = bar.height;
                                    const x = bar.x;
                                    const y = bar.y + barHeight / 2 + 4;

                                    ctx.fillStyle = '#ffffff';
                                    ctx.fillText(`${pct}%`, x, y);
                                }
                            });
                        });
                        ctx.restore();
                    }
                }]
            });
        }

        function updateRegionChart(data) {
            const ctx = document.getElementById('chartRegions').getContext('2d');
            if (chartInstances.regions) chartInstances.regions.destroy();

            chartInstances.regions = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.region_name),
                    datasets: [{
                        label: 'Spend',
                        data: data.map(d => d.spend),
                        backgroundColor: colors.amber,
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        // Breakdown Table with comparison
        function updateBreakdownTable(data, comparisonData) {
            const tbody = document.getElementById('breakdownTable');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-slate-400">No data available</td></tr>';
                return;
            }

            const channelBadge = (channel) => {
                if (channel === 'Facebook') return '<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded-full">FB</span>';
                if (channel === 'Instagram') return '<span class="px-2 py-1 text-xs font-medium bg-pink-100 text-pink-700 rounded-full">IG</span>';
                return '<span class="px-2 py-1 text-xs font-medium bg-slate-100 text-slate-700 rounded-full">Other</span>';
            };

            const objectiveBadge = (obj) => {
                if (obj === 'Message') return '<span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-700 rounded-full">Mess</span>';
                if (obj === 'Impression') return '<span class="px-2 py-1 text-xs font-medium bg-teal-100 text-teal-700 rounded-full">Impr</span>';
                if (obj === 'Visit') return '<span class="px-2 py-1 text-xs font-medium bg-amber-100 text-amber-700 rounded-full">Visit</span>';
                return '<span class="px-2 py-1 text-xs font-medium bg-slate-100 text-slate-700 rounded-full">' + obj + '</span>';
            };

            // Helper to find comparison data by campaign name
            const findComparison = (campaignName) => {
                if (!comparisonData || !state.compare) return null;
                return comparisonData.find(c => c.campaign_name === campaignName);
            };

            // Helper to render value with comparison
            const renderWithComparison = (current, previous, isCurrency = false, invertColor = false) => {
                const formattedValue = isCurrency ? formatCurrency(current || 0) : formatNumber(current || 0);
                if (!previous || !state.compare) return formattedValue;

                const change = previous > 0 ? ((current - previous) / previous * 100) : 0;
                if (Math.abs(change) < 0.1) return formattedValue;

                // For CPR/CPM, lower is better so invert the color
                const isPositive = invertColor ? change < 0 : change > 0;
                const colorClass = isPositive ? 'text-emerald-600' : 'text-rose-600';
                const arrow = change > 0 ? '↑' : '↓';

                return `
                    <div>${formattedValue}</div>
                    <div class="text-xs ${colorClass}">${arrow} ${Math.abs(change).toFixed(1)}%</div>
                `;
            };

            tbody.innerHTML = data.map(row => {
                const prev = findComparison(row.campaign_name);
                return `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 font-medium text-slate-900">${row.campaign_name}</td>
                    <td class="px-6 py-4">${channelBadge(row.channel)}</td>
                    <td class="px-6 py-4">${objectiveBadge(row.objective)}</td>
                    <td class="px-6 py-4 text-right tabular-nums font-medium">${renderWithComparison(row.total_spend, prev?.total_spend, true)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${renderWithComparison(row.total_impressions, prev?.total_impressions)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${renderWithComparison(row.total_results, prev?.total_results)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${renderWithComparison(row.cpr, prev?.cpr, true, true)}</td>
                    <td class="px-6 py-4 text-right tabular-nums text-slate-600">${renderWithComparison(row.cpm, prev?.cpm, true, true)}</td>
                </tr>
            `}).join('');
        }

        // Update Top Ads Rankings
        function updateTopAds(data) {
            const renderTopList = (containerId, items, valueKey, valueLabel, colorClass) => {
                const container = document.getElementById(containerId);
                if (!items || items.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-400 py-4">No data available</div>';
                    return;
                }

                const medals = ['🥇', '🥈', '🥉'];

                container.innerHTML = items.map((item, index) => `
                    <div class="flex items-start gap-3 p-3 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors">
                        <span class="text-xl">${medals[index] || (index + 1)}</span>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-slate-900 text-sm truncate" title="${item.ad_name}">${item.ad_name}</p>
                            <div class="flex items-center gap-3 mt-1">
                                <span class="text-xs ${colorClass} font-bold">${formatNumber(item[valueKey])} ${valueLabel}</span>
                                <span class="text-xs text-slate-400">${formatCurrency(item.total_spend)}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            };

            renderTopList('topMessagesFB', data.top_messages_fb, 'total_results', 'messages', 'text-blue-600');
            renderTopList('topMessagesIG', data.top_messages_ig, 'total_results', 'messages', 'text-pink-600');
            renderTopList('topImpressions', data.top_impressions, 'total_impressions', 'impressions', 'text-teal-600');
            renderTopList('topVisitIG', data.top_visit_ig, 'total_results', 'visits', 'text-amber-600');
        }

        // Update Top Products Rankings
        function updateTopProducts(data) {
            const renderProductList = (containerId, items, valueLabel, colorClass) => {
                const container = document.getElementById(containerId);
                if (!items || items.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-400 py-4">No data available</div>';
                    return;
                }

                const medals = ['🥇', '🥈', '🥉', '4️⃣', '5️⃣'];

                container.innerHTML = items.map((item, index) => `
                    <div class="flex items-center gap-3 p-2 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                        <span class="text-lg">${medals[index] || (index + 1)}</span>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-slate-900 text-sm">${item.product_line}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold ${colorClass}">${formatNumber(item.total)}</p>
                            <p class="text-xs text-slate-400">${formatCurrency(item.spend)}</p>
                        </div>
                    </div>
                `).join('');
            };

            renderProductList('topMessageProducts', data.top_message_products, 'messages', 'text-purple-600');
            renderProductList('topImpressionProducts', data.top_impression_products, 'impressions', 'text-teal-600');
            renderProductList('topVisitProducts', data.top_visit_products, 'visits', 'text-amber-600');
        }

        // --- FORMATTERS ---
        const formatCurrency = (val) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 }).format(val);
        const formatNumber = (val) => new Intl.NumberFormat('vi-VN').format(val);
        const formatDate = (str) => {
            // Parse date string as local date (not UTC) to avoid timezone offset issues
            const parts = str.split('-');
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const day = parseInt(parts[2], 10);
            return `${day}/${month}`;
        }

        // Calculate percentage change
        function calcChange(current, previous) {
            if (!previous || previous === 0) return null;
            return ((current - previous) / previous) * 100;
        }

        // Format change badge
        function formatChangeBadge(change, inverse = false) {
            if (change === null) return '';
            const isPositive = inverse ? change < 0 : change > 0;
            const arrow = change > 0 ? '↑' : '↓';
            const colorClass = isPositive ? 'text-green-600' : 'text-red-500';
            return `<span class="${colorClass}">${arrow} ${Math.abs(change).toFixed(1)}%</span>`;
        }

        // Update change element
        function updateChangeEl(elementId, current, previous, inverse = false) {
            const el = document.getElementById(elementId);
            if (!el) return;

            if (state.compare && previous !== undefined) {
                const change = calcChange(current, previous);
                if (change !== null) {
                    el.innerHTML = formatChangeBadge(change, inverse);
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            } else {
                el.classList.add('hidden');
            }
        }

        // --- INIT & EVENTS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Flatpickr
            flatpickr("#datePickerBtn", {
                mode: "range",
                dateFormat: "Y-m-d",
                defaultDate: [new Date().setDate(new Date().getDate() - 30), new Date()],
                locale: "vn", // Would need locale script, default English for now
                onChange: function (selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        const start = selectedDates[0];
                        const end = selectedDates[1];
                        // Format to YYYY-MM-DD using local date (avoid timezone issues)
                        const fmt = d => {
                            const year = d.getFullYear();
                            const month = String(d.getMonth() + 1).padStart(2, '0');
                            const day = String(d.getDate()).padStart(2, '0');
                            return `${year}-${month}-${day}`;
                        };
                        state.startDate = fmt(start);
                        state.endDate = fmt(end);

                        // Update Button Text
                        document.getElementById('dateText').innerText = `${formatDate(state.startDate)} - ${formatDate(state.endDate)}`;

                        refreshData();
                    }
                }
            });

            // Set initial state - use local date format to avoid timezone issues
            const formatLocalDate = d => {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - 30);
            state.startDate = formatLocalDate(start);
            state.endDate = formatLocalDate(end);
            document.getElementById('dateText').innerText = `${formatDate(state.startDate)} - ${formatDate(state.endDate)}`;

            // Toggle Comparison
            document.getElementById('compareToggle').addEventListener('change', (e) => {
                state.compare = e.target.checked;
                refreshData();
            });

            refreshData();
        });


    </script>
</body>

</html>